<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>سلة الفواكه</title>

  <!-- Single, clean viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <link rel="icon" href="Logo.png" type="image/png" />

  <style>
    :root { color-scheme: light dark; }

    /* Reset */
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      background: #000; overflow: hidden;
      touch-action: manipulation; /* reduce double-tap zooms */
    }

    /* Stable container space (use svh to avoid iOS toolbar jumps) */
    #unity-container {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: #000;
      height: 100svh; /* <-- stable viewport height on iOS 16+ */
      width: 100vw;
    }

    /* The canvas we resize explicitly (no HTML width/height attrs) */
    #unity-canvas {
      display: block;
      background: #231F20;
      image-rendering: auto;
      width: 100%;   /* initial */
      height: 100%;  /* initial */
    }

    /* Loading bar */
    #unity-loading-bar {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      display: flex; flex-direction: column; align-items: center; gap: 20px;
      z-index: 10; pointer-events: none;
    }
    #unity-logo1 { width: 40vw; max-width: 280px; height: auto; }
    #unity-progress-bar {
      width: 764px; max-width: 90vw; height: 40px; margin-top: 60px;
      background: url('bar.png') no-repeat center / 100% 100%;
      position: relative; overflow: hidden; border-radius: 10px;
      transform: scale(0.7); transform-origin: top center;
    }
    #unity-progress-bar-fill {
      position: absolute; top: 7px; left: 6px; height: calc(100% - 14px);
      width: 0%; background: #55CAC2; transition: width .3s ease;
      border-radius: 20px 0 0 20px;
    }
    @media (max-width: 768px) {
      #unity-logo1 { width: 50vw; max-width: 200px; }
      #unity-progress-bar { width: 550px; height: 30px; margin-top: 0; }
      #unity-progress-bar-fill { border-radius: 5px 0 0 5px; }
    }

    /* Fake Fullscreen fallback */
    .fake-fs, .fake-fs body {
      height: 100svh; width: 100vw; overflow: hidden !important;
      background: #000;
    }
    .fake-fs #unity-container,
    .fake-fs #unity-canvas {
      position: fixed !important;
      inset: 0 !important;
      width: 100vw !important;
      height: 100svh !important;
      transform: none !important;
    }
  </style>
</head>

<body>
  <div id="unity-container">
    <canvas id="unity-canvas" tabindex="-1"></canvas>

    <div id="unity-loading-bar">
      <img id="unity-logo1" src="logo1.png" alt="Loading Logo" />
      <div id="unity-progress-bar">
        <div id="unity-progress-bar-fill"></div>
      </div>
    </div>
  </div>

  <!-- Layout: lock aspect ratio with letterbox (no stretch) -->
  <script>
    (function () {
      const TARGET_W = 1280;       // design width
      const TARGET_H = 720;        // design height
      const TARGET_ASPECT = TARGET_W / TARGET_H;

      function sizeToLetterbox() {
        const container = document.getElementById('unity-container');
        const canvas = document.getElementById('unity-canvas');
        if (!container || !canvas) return;

        // Use container's stable box (svh-based), avoids toolbar jumps on iOS
        const W = Math.max(1, container.clientWidth);
        const H = Math.max(1, container.clientHeight);
        const aspect = W / H;

        let drawW, drawH;
        if (aspect > TARGET_ASPECT) {
          // Container is wider -> full height, reduce width
          drawH = H;
          drawW = Math.round(drawH * TARGET_ASPECT);
        } else {
          // Container is taller -> full width, reduce height
          drawW = W;
          drawH = Math.round(drawW / TARGET_ASPECT);
        }

        canvas.style.width = drawW + 'px';
        canvas.style.height = drawH + 'px';

        // Center it
        canvas.style.marginLeft = ((W - drawW) >> 1) + 'px';
        canvas.style.marginRight = canvas.style.marginLeft;
        canvas.style.marginTop = ((H - drawH) >> 1) + 'px';
        canvas.style.marginBottom = canvas.style.marginTop;
      }

      let scheduled = false;
      const schedule = () => {
        if (scheduled) return;
        scheduled = true;
        requestAnimationFrame(() => { scheduled = false; sizeToLetterbox(); });
      };

      window.addEventListener('load', schedule, { passive: true });
      window.addEventListener('resize', schedule, { passive: true });
      window.addEventListener('orientationchange', schedule, { passive: true });

      if (window.visualViewport) {
        visualViewport.addEventListener('resize', schedule, { passive: true });
        visualViewport.addEventListener('scroll', schedule, { passive: true });
      }

      // Initial
      sizeToLetterbox();
      document.body.style.overscrollBehavior = 'none';
    })();
  </script>

  <!-- Fullscreen helpers (iOS/iPad first-class) -->
  <script>
    function canUseFullscreen() {
      return !!(document.fullscreenEnabled || document.webkitFullscreenEnabled);
    }

    async function requestFullscreenOn(elem) {
      if (!elem) throw new Error('No element for fullscreen');
      if (elem.requestFullscreen) return elem.requestFullscreen({ navigationUI: "hide" });
      if (elem.webkitRequestFullscreen) return elem.webkitRequestFullscreen(); // iOS/Safari
      throw new Error('Fullscreen API not available on element');
    }

    function isInFullscreen() {
      return !!(document.fullscreenElement || document.webkitFullscreenElement);
    }

    function enableFakeFullscreen() {
      document.documentElement.classList.add('fake-fs');
      document.body.classList.add('fake-fs');
      setTimeout(() => window.scrollTo(0, 1), 30);
    }
    function disableFakeFullscreen() {
      document.documentElement.classList.remove('fake-fs');
      document.body.classList.remove('fake-fs');
    }

    async function tryLockOrientation() {
      try {
        if (screen.orientation && screen.orientation.lock) {
          await screen.orientation.lock('landscape'); // best-effort; ignored if not allowed
        }
      } catch (_) {}
    }

    async function enterFullscreenStrong() {
      const canvas = document.getElementById('unity-canvas');
      const container = document.getElementById('unity-container');
      try {
        if (canUseFullscreen()) {
          try {
            await requestFullscreenOn(canvas);
          } catch (e1) {
            try {
              await requestFullscreenOn(container);
            } catch (e2) {
              await requestFullscreenOn(document.documentElement);
            }
          }
          // Try orientation lock inside FS (Safari iOS 16+ sometimes honors this)
          tryLockOrientation();
        } else {
          enableFakeFullscreen();
        }
      } catch (err) {
        // If native FS rejected, use fake
        enableFakeFullscreen();
        console.warn('Native fullscreen failed; using fake fullscreen:', err);
      }
    }

    document.addEventListener('fullscreenchange', () => {
      if (!isInFullscreen()) disableFakeFullscreen();
    });
    document.addEventListener('webkitfullscreenchange', () => {
      if (!isInFullscreen()) disableFakeFullscreen();
    });
  </script>

  <!-- Unity boot + request fullscreen on first user gesture -->
  <script>
    window.addEventListener("load", function () {
      const canvas = document.querySelector("#unity-canvas");
      const loadingBar = document.querySelector("#unity-loading-bar");
      const progressBarFill = document.querySelector("#unity-progress-bar-fill");

      const buildUrl = "Build";
      const loaderUrl = buildUrl + "/Build.loader.js";
      const config = {
        dataUrl: buildUrl + "/Build.data.unityweb",
        frameworkUrl: buildUrl + "/Build.framework.js.unityweb",
        codeUrl: buildUrl + "/Build.wasm.unityweb",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "AQTAR",
        productName: "البرتقالة الذكية",
        productVersion: "1.0",
        matchWebGLToCanvasSize: true,
        devicePixelRatio: Math.min(2, window.devicePixelRatio || 1)
      };

      loadingBar.style.display = "flex";

      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressBarFill.style.width = (progress * 100) + "%";
        }).then(() => {
          loadingBar.style.display = "none";
        }).catch((message) => {
          alert("Unity load failed: " + message);
        });
      };
      document.body.appendChild(script);

      // Request fullscreen at very first gesture (works for iOS/iPad)
      function enterFSOnce() {
        enterFullscreenStrong();
        window.removeEventListener('pointerdown', enterFSOnce);
        window.removeEventListener('touchstart', enterFSOnce);
        window.removeEventListener('click', enterFSOnce);
      }
      // Use pointerdown so the request happens before Unity might swallow the event
      window.addEventListener('pointerdown', enterFSOnce, { once: true, passive: true });
      window.addEventListener('touchstart', enterFSOnce, { once: true, passive: true });
      window.addEventListener('click', enterFSOnce, { once: true, passive: true });
    });
  </script>
</body>
</html>
