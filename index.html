<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>سلة الفواكه</title>

  <!-- ميتا فيوبورت مرة واحدة فقط -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <link rel="icon" href="Logo.png" type="image/png" />

  <style>
    :root { color-scheme: light dark; }
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      background: #000; overflow: hidden;
    }

    /* الحاوية: تمركز + 100dvh لتقليل قفزات iOS */
    #unity-container {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: #000; height: 100dvh;
    }

    /* لا تضبط خصائص width/height على عنصر الـcanvas HTML attributes */
    #unity-canvas {
      display: block;
      background: #231F20;
      transform-origin: center center;
      width: 100%;
      height: 100%;
      image-rendering: auto;
    }

    /* اللودينج بار */
    #unity-loading-bar {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      display: flex; flex-direction: column; align-items: center; gap: 20px;
      z-index: 10; pointer-events: none;
    }
    #unity-logo1 { width: 40vw; max-width: 280px; height: auto; }
    #unity-progress-bar {
      width: 764px; max-width: 90vw; height: 40px; margin-top: 60px;
      background: url('bar.png') no-repeat center / 100% 100%;
      position: relative; overflow: hidden; border-radius: 10px;
      transform: scale(0.7); transform-origin: top center;
    }
    #unity-progress-bar-fill {
      position: absolute; top: 7px; left: 6px; height: calc(100% - 14px);
      width: 0%; background: #55CAC2; transition: width .3s ease;
      border-radius: 20px 0 0 20px;
    }
    @media (max-width: 768px) {
      #unity-logo1 { width: 50vw; max-width: 200px; }
      #unity-progress-bar { width: 550px; height: 30px; margin-top: 0; }
      #unity-progress-bar-fill { border-radius: 5px 0 0 5px; }
    }

    /* Fake Fullscreen fallback (لأجهزة iOS العنيدة / PWA) */
    .fake-fs, .fake-fs body {
      height: 100dvh; width: 100vw; overflow: hidden !important;
      background: #000;
    }
    .fake-fs #unity-container,
    .fake-fs #unity-canvas {
      position: fixed !important;
      inset: 0 !important;
      width: 100vw !important;
      height: 100dvh !important;
      transform: none !important;
    }
  </style>
</head>

<body>
  <div id="unity-container">
    <canvas id="unity-canvas" tabindex="-1"></canvas>

    <div id="unity-loading-bar">
      <img id="unity-logo1" src="logo1.png" alt="Loading Logo" />
      <div id="unity-progress-bar">
        <div id="unity-progress-bar-fill"></div>
      </div>
    </div>
  </div>

  <!-- سكربت تخطيط: بورتريه يملأ الشاشة، لاندسكيب 16:9 -->
  <script>
    (function () {
      const TARGET_ASPECT = 16 / 9;

      const isMobile = () => /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const vw = () => (window.visualViewport ? Math.floor(window.visualViewport.width)  : window.innerWidth);
      const vh = () => (window.visualViewport ? Math.floor(window.visualViewport.height) : window.innerHeight);
      const isPortrait = () => vh() >= vw();

      function layout() {
        const canvas = document.getElementById('unity-canvas');
        if (!canvas) return;

        if (!isMobile()) {
          // Desktop: Letterbox 16:9
          const W = vw(), H = vh(), aspect = W / H;
          let drawW, drawH;
          if (aspect > TARGET_ASPECT) { drawH = H; drawW = Math.round(drawH * TARGET_ASPECT); }
          else { drawW = W; drawH = Math.round(drawW / TARGET_ASPECT); }
          canvas.style.width = drawW + 'px';
          canvas.style.height = drawH + 'px';
          canvas.style.transform = '';
          return;
        }

        if (isPortrait()) {
          // Portrait mobile: املأ العرض والارتفاع بالكامل
          canvas.style.width  = vw() + 'px';
          canvas.style.height = vh() + 'px';
          canvas.style.transform = '';
        } else {
          // Landscape mobile: حافظ على 16:9 (Letterbox)
          const W = vw(), H = vh(), aspect = W / H;
          let drawW, drawH;
          if (aspect > TARGET_ASPECT) { drawH = H; drawW = Math.round(drawH * TARGET_ASPECT); }
          else { drawW = W; drawH = Math.round(drawW / TARGET_ASPECT); }
          canvas.style.width = drawW + 'px';
          canvas.style.height = drawH + 'px';
          canvas.style.transform = '';
        }
      }

      // جدولة لتقليل إعادة الحساب
      let scheduled = false;
      const schedule = () => {
        if (scheduled) return;
        scheduled = true;
        requestAnimationFrame(() => { scheduled = false; layout(); });
      };

      window.addEventListener('load', schedule, { passive: true });
      window.addEventListener('resize', schedule, { passive: true });
      window.addEventListener('orientationchange', schedule, { passive: true });
      if (window.visualViewport) {
        visualViewport.addEventListener('resize', schedule, { passive: true });
        visualViewport.addEventListener('scroll', schedule, { passive: true });
      }

      // تشغيل أولي
      layout();
      document.body.style.overscrollBehavior = 'none';
    })();
  </script>

  <!-- Helpers: Fullscreen قوي + بديل وهمي -->
  <script>
    // --- Fullscreen helpers ---
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }

    function canUseFullscreen() {
      return !!(document.fullscreenEnabled || document.webkitFullscreenEnabled);
    }

    async function requestFullscreenOn(elem) {
      if (!elem) throw new Error('No element for fullscreen');
      if (elem.requestFullscreen) return elem.requestFullscreen({ navigationUI: "hide" });
      if (elem.webkitRequestFullscreen) return elem.webkitRequestFullscreen(); // iOS/Safari
      throw new Error('Fullscreen API not available on element');
    }

    function exitFullscreen() {
      if (document.exitFullscreen) return document.exitFullscreen();
      if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
    }

    function isInFullscreen() {
      return !!(document.fullscreenElement || document.webkitFullscreenElement);
    }

    // Fallback “fake fullscreen” for stubborn iOS/PWA
    function enableFakeFullscreen() {
      document.documentElement.classList.add('fake-fs');
      document.body.classList.add('fake-fs');
      // محاولة إخفاء الأشرطة
      setTimeout(() => window.scrollTo(0, 1), 50);
    }
    function disableFakeFullscreen() {
      document.documentElement.classList.remove('fake-fs');
      document.body.classList.remove('fake-fs');
    }

    // Try hard to go fullscreen on first user gesture
    async function enterFullscreenStrong() {
      try {
        const canvas = document.getElementById('unity-canvas');
        const container = document.getElementById('unity-container');

        if (canUseFullscreen()) {
          try {
            await requestFullscreenOn(canvas);
          } catch (e1) {
            try {
              await requestFullscreenOn(container);
            } catch (e2) {
              await requestFullscreenOn(document.documentElement);
            }
          }
        } else {
          // Older iOS / PWA windowed mode
          enableFakeFullscreen();
        }
      } catch (err) {
        // As a last resort, fake FS
        enableFakeFullscreen();
        console.warn('Native fullscreen failed, using fake:', err);
      }
    }

    // Keep layout/state correct when FS toggles
    document.addEventListener('fullscreenchange', () => {
      if (!isInFullscreen()) disableFakeFullscreen();
    });
    document.addEventListener('webkitfullscreenchange', () => {
      if (!isInFullscreen()) disableFakeFullscreen();
    });
  </script>

  <!-- تحميل Unity + Fullscreen مرة واحدة عند أول تفاعل -->
  <script>
    window.addEventListener("load", function () {
      const canvas = document.querySelector("#unity-canvas");
      const loadingBar = document.querySelector("#unity-loading-bar");
      const progressBarFill = document.querySelector("#unity-progress-bar-fill");

      const buildUrl = "Build";
      const loaderUrl = buildUrl + "/Build.loader.js";
      const config = {
        dataUrl: buildUrl + "/Build.data.unityweb",
        frameworkUrl: buildUrl + "/Build.framework.js.unityweb",
        codeUrl: buildUrl + "/Build.wasm.unityweb",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "AQTAR",
        productName: "البرتقالة الذكية",
        productVersion: "1.0",
        matchWebGLToCanvasSize: true,
        devicePixelRatio: Math.min(2, window.devicePixelRatio || 1)
      };

      loadingBar.style.display = "flex";

      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressBarFill.style.width = (progress * 100) + "%";
        }).then(() => {
          loadingBar.style.display = "none";
        }).catch((message) => {
          alert("Unity load failed: " + message);
        });
      };
      document.body.appendChild(script);

      // اطلب ملء الشاشة عند أول تفاعل (مناسب للموبايل و iPad iOS)
      function enterFSOnce() {
        enterFullscreenStrong();
        window.removeEventListener('pointerdown', enterFSOnce);
        window.removeEventListener('touchstart', enterFSOnce);
        window.removeEventListener('click', enterFSOnce);
      }
      // استخدم pointerdown (يشمل اللمس والماوس) قبل أن يلتقط Unity الإدخال
      window.addEventListener('pointerdown', enterFSOnce, { once: true, passive: true });
      // ضمان إضافي لبعض الأجهزة
      window.addEventListener('touchstart', enterFSOnce, { once: true, passive: true });
      window.addEventListener('click', enterFSOnce, { once: true, passive: true });
    });
  </script>
</body>
</html>
